<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KOMPASS EOD System v3.4</title>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <style>
        :root {
            --primary: #0d4f8b;
            --primary-hover: #1e66ab;
            --secondary: #4b5563;
            --success: #56ab2f;
            --danger: #dc2626;
            --background: #374151;
            --surface: #111827;
            --surface-alt: #020617;
            --text-main: #f9fafb;
            --text-muted: #d1d5db;
            --accent: #88c4ed;
            --highlight-border: #60a5fa;
            --highlight-bg: #1f2937;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--background);
            color: var(--text-main);
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* --- Header --- */
        .app-header {
            background: var(--surface);
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 10;
            flex-shrink: 0;
        }
        .header-logo { max-height: 70px; margin-bottom: 5px; }
        .app-title { color: var(--accent); font-size: 1.1rem; font-weight: 700; margin: 0; }

        /* --- Main Content Area --- */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 100px;
            scroll-behavior: smooth;
        }

        .section-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .section-title {
            color: var(--accent);
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--secondary);
        }

        /* --- Forms --- */
        .field-group { margin-bottom: 20px; scroll-margin-top: 80px; }
        label { display: block; margin-bottom: 8px; color: var(--text-muted); font-size: 0.9rem; font-weight: 600; }
        
        input[type="text"], input[type="date"], input[type="email"], textarea, select {
            width: 100%;
            padding: 12px;
            background: var(--surface-alt);
            border: 1px solid var(--secondary);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent); }
        
        .manager-field {
            background-color: var(--highlight-bg) !important;
            border: 2px solid var(--highlight-border) !important;
            box-shadow: 0 0 10px rgba(96, 165, 250, 0.1);
        }
        
        .field-group.error-state input, 
        .field-group.error-state textarea,
        .field-group.error-state select,
        .field-group.error-state canvas { 
            border-color: var(--danger) !important; 
            box-shadow: 0 0 0 1px var(--danger);
        }
        
        .error-msg { 
            color: var(--danger); 
            font-size: 0.85rem; 
            margin-top: 5px; 
            display: none; 
            font-weight: bold;
        }
        .field-group.error-state .error-msg { display: block; }

        /* --- Toggle Buttons (Radios) --- */
        .toggle-group { display: flex; gap: 10px; background: var(--surface-alt); padding: 4px; border-radius: 8px; margin-bottom: 10px; }
        .toggle-option { flex: 1; text-align: center; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; color: var(--text-muted); transition: all 0.2s; }
        .toggle-option.selected { background: var(--primary); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        /* --- Photos --- */
        .photo-section {
            background: rgba(255,255,255,0.03);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .photo-slot {
            aspect-ratio: 1;
            background: var(--surface-alt);
            border: 1px dashed var(--secondary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .photo-slot img { width: 100%; height: 100%; object-fit: cover; }
        
        .photo-actions {
            position: absolute; inset: 0; background: rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s;
        }
        .photo-slot:hover .photo-actions { opacity: 1; }
        
        .add-photo-btn { flex-direction: column; gap: 2px; color: var(--accent); text-align: center; }
        .add-photo-btn span { font-size: 1.5rem; }

        /* --- Signature --- */
        .sig-pad-container { 
            background: white; 
            border-radius: 8px; 
            height: 150px; 
            position: relative; 
            touch-action: none; 
            border: 1px solid var(--secondary); 
            width: 100%;
            overflow: hidden;
        }
        canvas#sigCanvas { width: 100%; height: 100%; display: block; }
        .sig-overlay-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #999; pointer-events: none; font-style: italic; }
        
        @media (orientation: landscape) and (max-height: 600px) {
            .sig-pad-container { height: 250px; }
        }

        /* --- Navigation Footer --- */
        .nav-footer {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--surface);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            gap: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
            z-index: 100;
        }

        .btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.95rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-reset { background: var(--secondary); color: white; width: 30%; }
        .btn-submit { background: var(--success); color: white; width: 70%; }
        .btn:active { transform: translateY(2px); }
        .btn-danger { background: var(--danger); color: white; }

        /* --- Overlay Commons --- */
        .overlay {
            position: fixed; inset: 0; z-index: 2000;
            background: #000; display: none; flex-direction: column;
            height: 100%; width: 100%;
        }
        .overlay.active { display: flex; }

        .cam-tools {
            flex-shrink: 0; z-index: 2010;
            padding: 15px; background: rgba(0,0,0,0.5);
            display: flex; justify-content: space-between; align-items: center;
        }
        .tool-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 15px; border-radius: 20px; backdrop-filter: blur(4px); font-weight: bold; }

        /* --- Camera --- */
        .cam-view {
            flex: 1; position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center; background: #000;
        }
        video#cameraFeed { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.3s ease-in; }
        .cam-loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid var(--accent); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .cam-controls {
            flex-shrink: 0; z-index: 2010; height: 100px;
            background: rgba(0,0,0,0.8);
            display: flex; align-items: center; justify-content: center;
        }
        .shutter-btn {
            width: 70px; height: 70px; border-radius: 50%;
            background: white; border: 4px solid var(--secondary);
            cursor: pointer; box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        #zoomControls { display: flex; align-items: center; gap: 10px; flex: 1; justify-content: center; margin: 0 15px; }
        input[type=range] { flex: 1; max-width: 150px; height: 4px; }

        /* --- Editor --- */
        #editorOverlay { z-index: 2050; } 
        
        .editor-stage { 
            flex: 1; background: #111; position: relative; display: flex; 
            align-items: center; justify-content: center; overflow: hidden; min-height: 0; 
        }
        #editorImage { max-width: 100%; max-height: 100%; display: block; object-fit: contain; }

        .editor-toolbar-custom {
            flex-shrink: 0; padding: 15px; background: var(--surface);
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.5); z-index: 2055;
        }
        .editor-toolbar-custom button {
            padding: 14px; border-radius: 8px; border: none; font-weight: bold; color: white; cursor: pointer; font-size: 0.9rem;
        }
        .btn-save-done { background: var(--success); }
        .btn-save-more { background: var(--primary); }
        .btn-retry { background: var(--secondary); }
        .btn-exit { background: var(--danger); }

        /* --- Viewer --- */
        .viewer-stage { flex: 1; background: #000; position: relative; overflow: hidden; }
        .viewer-controls {
            position: absolute; bottom: 30px; left: 0; right: 0;
            display: flex; justify-content: center; gap: 25px;
            pointer-events: none; z-index: 2020;
        }
        .viewer-controls button {
            pointer-events: auto; min-width: 120px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.6);
            border: 2px solid rgba(255,255,255,0.1);
        }

        /* Modal Backdrops */
        .modal-backdrop {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000;
            display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: var(--surface); padding: 25px; border-radius: 12px;
            width: 90%; max-width: 350px; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            border: 1px solid var(--secondary);
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid var(--secondary);
            border-top: 4px solid var(--accent); border-radius: 50%;
            margin: 0 auto 15px auto; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Copy Field Styling */
        .copy-field-group {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        .copy-input {
            flex: 1;
            background: #000;
            border: 1px solid var(--secondary);
            color: var(--accent);
            padding: 10px;
            font-size: 0.9rem;
            border-radius: 6px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .btn-copy {
            background: var(--secondary);
            border: none;
            border-radius: 6px;
            padding: 0 15px;
            cursor: pointer;
            color: white;
            font-size: 1.2rem;
        }
        .btn-copy:active { background: var(--primary); }

    </style>
</head>
<body>

    <!-- Header -->
    <header class="app-header">
        <img src="rologo.png" alt="Logo" class="header-logo" onerror="this.style.display='none'">
        <h1 class="app-title">KOMPASS EOD System</h1>
    </header>
    
    <!-- Main Scrolling Content -->
    <main class="main-content" id="mainContainer">
        
        <!-- SECTION: IDENTIFICATION -->
        <div class="section-card">
            <div class="section-title">Identification</div>
            
            <div class="field-group" id="fg-store">
                <label>Store Number *</label>
                <select id="storeNumber" onchange="saveData()">
                    <option value="" disabled selected>Select Store...</option>
                    <!-- Populated via JS -->
                </select>
                <div class="error-msg">Select a store number</div>
            </div>

            <div class="field-group" id="fg-date">
                <label>Date *</label>
                <input type="date" id="workDate" onchange="this.blur(); saveData()">
                <div class="error-msg">Date cannot be in the future</div>
            </div>

            <div class="field-group" id="fg-lead">
                <label>Lead Name *</label>
                <input type="text" id="leadName" placeholder="First and Last" onchange="saveData()">
                <div class="error-msg">Lead name required</div>
            </div>

            <div class="field-group" id="fg-inMgr">
                <label>Manager Checked In With *</label>
                <input type="text" id="checkInManager" class="manager-field" placeholder="First and Last" onchange="saveData()">
                <div class="error-msg">Manager name required</div>
            </div>
        </div>

        <!-- SECTION: PHOTOS -->
        <div class="section-card">
            <div class="section-title">Photos</div>
            
            <!-- Before -->
            <div class="photo-section">
                <label>Before picture of KOMPASS cart taken? *</label>
                <div class="toggle-group" id="tg-beforeTaken">
                    <div class="toggle-option" onclick="setToggle('beforeTaken', true)">Yes</div>
                    <div class="toggle-option selected" onclick="setToggle('beforeTaken', false)">No</div>
                </div>

                <label style="font-size: 0.85rem; margin-top: 10px;">Add Photos</label>
                <div class="photo-grid" id="grid-before">
                    <div class="photo-slot add-photo-btn" onclick="launchCamera('before')">
                        <span>üì∑</span><div>Cam</div>
                    </div>
                    <div class="photo-slot add-photo-btn" onclick="document.getElementById('file-before').click()">
                        <span>üìÅ</span><div>File</div>
                    </div>
                </div>
                <input type="file" id="file-before" hidden accept="image/*" onchange="handleFileUpload(this, 'before')">
            </div>

            <!-- After -->
            <div class="photo-section">
                <label>After picture of KOMPASS cart taken? *</label>
                <div class="toggle-group" id="tg-afterTaken">
                    <div class="toggle-option" onclick="setToggle('afterTaken', true)">Yes</div>
                    <div class="toggle-option selected" onclick="setToggle('afterTaken', false)">No</div>
                </div>

                <label style="font-size: 0.85rem; margin-top: 10px;">Add Photos</label>
                <div class="photo-grid" id="grid-after">
                    <div class="photo-slot add-photo-btn" onclick="launchCamera('after')">
                        <span>üì∑</span><div>Cam</div>
                    </div>
                    <div class="photo-slot add-photo-btn" onclick="document.getElementById('file-after').click()">
                        <span>üìÅ</span><div>File</div>
                    </div>
                </div>
                <input type="file" id="file-after" hidden accept="image/*" onchange="handleFileUpload(this, 'after')">
            </div>

            <!-- Signoff -->
            <div class="photo-section">
                <label>Photos of sign-off sheets taken? *</label>
                <div class="toggle-group" id="tg-signoffTaken">
                    <div class="toggle-option" onclick="setToggle('signoffTaken', true)">Yes</div>
                    <div class="toggle-option selected" onclick="setToggle('signoffTaken', false)">No</div>
                </div>

                <label style="font-size: 0.85rem; margin-top: 10px;">Add Photos</label>
                <div class="photo-grid" id="grid-signoff">
                    <div class="photo-slot add-photo-btn" onclick="launchCamera('signoff')">
                        <span>üì∑</span><div>Cam</div>
                    </div>
                    <div class="photo-slot add-photo-btn" onclick="document.getElementById('file-signoff').click()">
                        <span>üìÅ</span><div>File</div>
                    </div>
                </div>
                <input type="file" id="file-signoff" hidden accept="image/*" multiple onchange="handleFileUpload(this, 'signoff')">
            </div>
        </div>

        <!-- SECTION: ISSUES -->
        <div class="section-card">
            <div class="section-title">Issues & Check Out</div>

            <div class="field-group">
                <label>Did you call KOMPASS Hotline? *</label>
                <div class="toggle-group" id="tg-hotline">
                    <div class="toggle-option" onclick="setToggle('hotline', true)">Yes</div>
                    <div class="toggle-option selected" onclick="setToggle('hotline', false)">No</div>
                </div>
            </div>

            <div id="hotline-fields" style="display:none; border-left: 2px solid var(--accent); padding-left: 15px; margin-bottom: 20px;">
                <div class="field-group" id="fg-comm">
                    <label>Commodities *</label>
                    <input type="text" id="commodities" onchange="saveData()">
                    <div class="error-msg">Required</div>
                </div>
                <div class="field-group" id="fg-issue">
                    <label>Issue Description *</label>
                    <textarea id="issueDesc" rows="2" onchange="saveData()"></textarea>
                    <div class="error-msg">Required</div>
                </div>
                <div class="field-group">
                    <label>Resolved? *</label>
                    <select id="issueResolved" onchange="handleResolvedChange()">
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                        <option value="NA">N/A</option>
                    </select>
                </div>
                <div class="field-group" id="tempSolutionGroup" style="display:none;">
                    <label>Temporary Solution *</label>
                    <textarea id="tempSolution" rows="2" onchange="saveData()"></textarea>
                    <div class="error-msg">Required if not resolved</div>
                </div>
            </div>

            <div class="field-group" id="fg-outMgr">
                <label>Manager Checked Out With *</label>
                <input type="text" id="checkOutManager" class="manager-field" placeholder="First and Last" onchange="saveData()">
                <div class="error-msg">Manager name required</div>
            </div>

            <div class="field-group">
                <label>Signed out in PROD? *</label>
                <div class="toggle-group" id="tg-prod">
                    <div class="toggle-option" onclick="setToggle('prod', true)">Yes</div>
                    <div class="toggle-option selected" onclick="setToggle('prod', false)">No</div>
                </div>
            </div>

            <div class="field-group">
                <label>Signed out in SI? *</label>
                <div class="toggle-group" id="tg-si">
                    <div class="toggle-option" onclick="setToggle('si', true)">Yes</div>
                    <div class="toggle-option selected" onclick="setToggle('si', false)">No</div>
                </div>
            </div>

            <div class="field-group">
                <label>General Notes</label>
                <textarea id="notes" rows="5" placeholder="Enter details about sets that were marked Not-Executable and remember that exceptions must match in both PROD and SI. Additionally, a comment must be made in the comment bubble in PROD and recorded here with details regarding the exception." onchange="saveData()"></textarea>
            </div>
        </div>

        <!-- SECTION: SIGNATURE -->
        <div class="section-card">
            <div class="section-title">Review & Sign</div>
            
            <div class="field-group">
                <label>Fred Meyer PIC who signed you out</label>
                <input type="email" id="emailTo" placeholder="firstname.lastname@stores.fredmeyer.com" onchange="saveData()">
            </div>

            <div class="field-group" id="fg-sig">
                <label>Signature *</label>
                <div class="sig-pad-container" id="sigContainer">
                    <canvas id="sigCanvas"></canvas>
                    <div class="sig-overlay-text" id="sigPlaceholder">Sign Here (Rotate for more space)</div>
                </div>
                <button class="mini-btn btn-reset" onclick="clearSignature()" style="margin-top: 8px; width: 100%;">Clear / Retry</button>
                <div class="error-msg">Signature required</div>
            </div>
        </div>

    </main>

    <!-- Footer Actions -->
    <footer class="nav-footer">
        <button class="btn btn-reset" onclick="resetForm()">Reset</button>
        <button class="btn btn-submit" onclick="validateAndSubmit()">Generate PDF & Email</button>
    </footer>

    <!-- OVERLAY: CAMERA -->
    <div id="cameraOverlay" class="overlay">
        <div class="cam-tools">
            <button class="tool-btn" onclick="closeCamera()">Cancel</button>
            <div id="zoomControls" style="display:none;">
                <span>-</span>
                <input type="range" id="zoomSlider" min="1" max="5" step="0.1" value="1">
                <span>+</span>
            </div>
            <button class="tool-btn" id="btnFlash" onclick="toggleFlash()">‚ö° Off</button>
        </div>
        <div class="cam-view">
            <div class="cam-loader" id="camLoader"></div>
            <video id="cameraFeed" autoplay playsinline></video>
        </div>
        <div class="cam-controls">
            <button class="shutter-btn" onclick="takePhoto()"></button>
        </div>
    </div>

    <!-- OVERLAY: EDITOR -->
    <div id="editorOverlay" class="overlay">
        <div class="cam-tools" style="background: rgba(0,0,0,0.7); justify-content: flex-end;">
            <button class="tool-btn" style="background: var(--success);" onclick="editorAction('save-close')">Save</button>
        </div>
        
        <div class="editor-stage">
            <img id="editorImage">
        </div>
        
        <div class="editor-toolbar-custom">
            <button class="btn-save-done" onclick="editorAction('save-close')">Accept & Finish</button>
            <button class="btn-save-more" onclick="editorAction('save-more')">Accept & Add More</button>
            <button class="btn-retry" onclick="editorAction('retry')">Discard & Retry</button>
            <button class="btn-exit" onclick="editorAction('exit')">Exit Camera</button>
        </div>
    </div>

    <!-- OVERLAY: PHOTO VIEWER -->
    <div id="photoViewerOverlay" class="overlay">
        <div class="viewer-stage">
            <img id="viewerImage" style="max-width: 100%; display: none;">
        </div>
        <div class="viewer-controls">
            <button class="btn btn-reset" onclick="closeViewer()">Back</button>
            <button class="btn btn-danger" onclick="deleteFromViewer()">Delete Photo</button>
        </div>
    </div>

    <!-- MODAL: LOADING -->
    <div id="loadingModal" class="modal-backdrop">
        <div class="modal-box">
            <div class="spinner"></div>
            <h3 style="color: var(--accent);">Processing</h3>
            <p>Generating PDF...</p>
        </div>
    </div>

    <!-- MODAL: READY TO SEND (Share Fix) -->
    <div id="shareModal" class="modal-backdrop">
        <div class="modal-box" style="text-align:left;">
            <h3 class="section-title" style="justify-content:center;">Ready to Send</h3>
            <p style="font-size:0.9rem; margin-bottom:15px; color:var(--text-muted); text-align:center;">
                The Share menu cannot auto-fill email addresses. 
                <br>Please copy them below before sharing.
            </p>
            
            <label>To:</label>
            <div class="copy-field-group">
                <input type="text" id="modalTo" class="copy-input" readonly>
                <button class="btn-copy" onclick="copyText('modalTo')">üìã</button>
            </div>

            <label>CC:</label>
            <div class="copy-field-group">
                <input type="text" id="modalCC" class="copy-input" readonly>
                <button class="btn-copy" onclick="copyText('modalCC')">üìã</button>
            </div>

            <button class="btn btn-submit" style="width:100%; margin-top:10px;" onclick="triggerNativeShare()">üöÄ Share PDF to App</button>
            <button class="btn btn-reset" style="width:100%; margin-top:10px; background:transparent; color:var(--text-muted); border:1px solid var(--secondary);" onclick="closeShareModal()">Cancel</button>
        </div>
    </div>

    <script>
        // --- STORE NUMBERS ---
        const storeList = [
            5, 7, 11, 13, 17, 18, 19, 21, 23, 24, 25, 28, 30, 31, 35, 40, 41, 49, 50, 
            51, 53, 60, 63, 70, 71, 75, 90, 93, 111, 122, 125, 126, 127, 135, 140, 143, 
            150, 153, 156, 158, 163, 165, 171, 180, 185, 186, 195, 196, 198, 208, 209, 
            210, 214, 215, 218, 220, 224, 225, 226, 227, 236, 240, 242, 255, 260, 265, 
            281, 285, 286, 325, 328, 351, 355, 360, 372, 375, 377, 383, 390, 391, 393, 
            417, 424, 439, 449, 457, 458, 459, 460, 462, 464, 482, 485, 486, 516, 600, 
            603, 604, 605, 608, 613, 614, 615, 649, 650, 651, 652, 653, 654, 655, 656, 
            657, 658, 659, 660, 661, 662, 663, 665, 667, 668, 681, 682, 683, 685, 688, 
            691, 694
        ];

        // --- STATE ---
        const state = {
            data: {
                hotline: false,
                prod: false,
                si: false,
                resolved: 'NA',
                beforeTaken: false,
                afterTaken: false,
                signoffTaken: false
            },
            photos: { before: [], after: [], signoff: [] },
            currentPhotoCategory: null,
            cameraStream: null,
            cropper: null,
            viewerCropper: null,
            viewerState: { cat: null, idx: null },
            tempShareData: null // Holds data for share modal
        };

        // --- INIT ---
        window.addEventListener('load', () => {
            const sel = document.getElementById('storeNumber');
            storeList.forEach(n => {
                const opt = document.createElement('option');
                opt.value = n;
                opt.textContent = n;
                sel.appendChild(opt);
            });

            document.getElementById('workDate').valueAsDate = new Date();
            setupSignature();
            loadSavedData();
        });

        // --- FORM LOGIC ---
        function setToggle(key, value) {
            state.data[key] = value;
            const container = document.getElementById(`tg-${key}`);
            const options = container.querySelectorAll('.toggle-option');
            options[0].classList.toggle('selected', value);
            options[1].classList.toggle('selected', !value);

            if (key === 'hotline') {
                document.getElementById('hotline-fields').style.display = value ? 'block' : 'none';
            }
            saveData();
        }

        function handleResolvedChange() {
            const val = document.getElementById('issueResolved').value;
            state.data.resolved = val;
            document.getElementById('tempSolutionGroup').style.display = (val === 'No') ? 'block' : 'none';
            saveData();
        }

        // --- PHOTOS SYSTEM ---
        async function launchCamera(category) {
            state.currentPhotoCategory = category;
            const overlay = document.getElementById('cameraOverlay');
            const video = document.getElementById('cameraFeed');
            const loader = document.getElementById('camLoader');
            
            video.style.opacity = "0";
            loader.style.display = "block";
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: { ideal: 1920 } } 
                });
                state.cameraStream = stream;
                video.srcObject = stream;
                overlay.classList.add('active');
                
                video.onloadedmetadata = () => {
                    loader.style.display = "none";
                    video.style.opacity = "1";
                };

                const track = stream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();
                const zoomCtrl = document.getElementById('zoomControls');
                
                if (capabilities.zoom) {
                    const slider = document.getElementById('zoomSlider');
                    zoomCtrl.style.display = 'flex';
                    slider.min = capabilities.zoom.min;
                    slider.max = capabilities.zoom.max;
                    slider.step = capabilities.zoom.step || 0.1;
                    slider.oninput = () => track.applyConstraints({ advanced: [{ zoom: slider.value }] });
                } else { zoomCtrl.style.display = 'none'; }

                document.getElementById('btnFlash').style.display = capabilities.torch ? 'block' : 'none';

            } catch (err) {
                alert("Camera unavailable. Check permissions.");
            }
        }

        function takePhoto() {
            const video = document.getElementById('cameraFeed');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
            openEditor(dataUrl);
        }

        function closeCamera() {
            if (state.cameraStream) {
                state.cameraStream.getTracks().forEach(t => t.stop());
                state.cameraStream = null;
            }
            document.getElementById('cameraOverlay').classList.remove('active');
        }

        function toggleFlash() {
            if (!state.cameraStream) return;
            const track = state.cameraStream.getVideoTracks()[0];
            const current = track.getSettings().torch || false;
            track.applyConstraints({ advanced: [{ torch: !current }] });
            document.getElementById('btnFlash').innerText = !current ? '‚ö° On' : '‚ö° Off';
        }

        function handleFileUpload(input, category) {
            state.currentPhotoCategory = category;
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => openEditor(e.target.result);
                reader.readAsDataURL(input.files[0]);
            }
            input.value = '';
        }

        // --- EDITOR ---
        function openEditor(imageUrl) {
            const overlay = document.getElementById('editorOverlay');
            const img = document.getElementById('editorImage');
            img.src = imageUrl;
            overlay.classList.add('active');
            if (state.cropper) state.cropper.destroy();
            
            img.style.display = 'block';
            
            state.cropper = new Cropper(img, { 
                viewMode: 1, 
                dragMode: 'move', 
                autoCropArea: 0.9, 
                background: false,
                responsive: true
            });
        }

        function editorAction(action) {
            if (!state.cropper) return;
            
            if (action === 'exit') {
                closeEditor();
                closeCamera();
                return;
            }
            if (action === 'retry') {
                closeEditor();
                return;
            }

            const category = state.currentPhotoCategory;
            const canvas = state.cropper.getCroppedCanvas({ maxWidth: 1200, maxHeight: 1200 });
            state.photos[category].push(canvas.toDataURL('image/jpeg', 0.8));
            setToggle(category + 'Taken', true);
            renderPhotos(category);
            saveData();

            closeEditor();

            if (action === 'save-close') {
                closeCamera();
            }
        }
        
        function closeEditor() {
            document.getElementById('editorOverlay').classList.remove('active');
            if (state.cropper) state.cropper.destroy();
            state.cropper = null;
        }

        function renderPhotos(category) {
            const container = document.getElementById(`grid-${category}`);
            const existing = container.querySelectorAll('.photo-item-wrapper');
            existing.forEach(e => e.remove());

            state.photos[category].forEach((src, idx) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'photo-slot photo-item-wrapper';
                wrapper.onclick = () => openViewer(category, idx);
                wrapper.innerHTML = `
                    <img src="${src}">
                    <div class="photo-actions">
                        <span style="color:white; font-weight:bold; font-size:0.8rem">View</span>
                    </div>
                `;
                container.insertBefore(wrapper, container.children[container.children.length - 2]);
            });
        }

        // --- VIEWER ---
        function openViewer(cat, idx) {
            state.viewerState = { cat, idx };
            const src = state.photos[cat][idx];
            const img = document.getElementById('viewerImage');
            const overlay = document.getElementById('photoViewerOverlay');
            img.src = src;
            img.style.display = 'block';
            overlay.classList.add('active');
            if(state.viewerCropper) state.viewerCropper.destroy();
            state.viewerCropper = new Cropper(img, {
                viewMode: 2, dragMode: 'move', autoCrop: false, background: false, modal: true, 
                guides: false, center: false, highlight: false, toggleDragModeOnDblclick: false
            });
        }

        function closeViewer() {
            document.getElementById('photoViewerOverlay').classList.remove('active');
            if(state.viewerCropper) state.viewerCropper.destroy();
            state.viewerCropper = null;
        }

        function deleteFromViewer() {
            if(confirm("Delete this photo?")) {
                const { cat, idx } = state.viewerState;
                state.photos[cat].splice(idx, 1);
                if(state.photos[cat].length === 0) setToggle(cat + 'Taken', false);
                renderPhotos(cat);
                saveData();
                closeViewer();
            }
        }

        // --- SIGNATURE ---
        function setupSignature() {
            const canvas = document.getElementById('sigCanvas');
            const container = document.getElementById('sigContainer');
            const ctx = canvas.getContext('2d');
            
            const resizeCanvas = () => {
                const rect = container.getBoundingClientRect();
                if (canvas.width === rect.width && canvas.height === rect.height) return;
                const wasBlank = isCanvasBlank(canvas);
                let savedData = null;
                if (!wasBlank) savedData = canvas.toDataURL();
                canvas.width = rect.width;
                canvas.height = rect.height;
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                if (savedData) {
                    const img = new Image();
                    img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    img.src = savedData;
                }
            };
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            let drawing = false;
            const start = (e) => {
                drawing = true;
                document.getElementById('sigPlaceholder').style.display = 'none';
                document.getElementById('fg-sig').classList.remove('error-state');
                ctx.beginPath();
                const {x, y} = getPos(e);
                ctx.moveTo(x, y);
            };
            const move = (e) => {
                if (!drawing) return;
                e.preventDefault();
                const {x, y} = getPos(e);
                ctx.lineTo(x, y);
                ctx.stroke();
            };
            const end = () => drawing = false;
            const getPos = (e) => {
                const r = canvas.getBoundingClientRect();
                const cx = e.touches ? e.touches[0].clientX : e.clientX;
                const cy = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: cx - r.left, y: cy - r.top };
            };

            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', move);
            canvas.addEventListener('mouseup', end);
            canvas.addEventListener('touchstart', start);
            canvas.addEventListener('touchmove', move);
            canvas.addEventListener('touchend', end);
        }

        function clearSignature() {
            const canvas = document.getElementById('sigCanvas');
            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('sigPlaceholder').style.display = 'block';
        }
        
        function isCanvasBlank(canvas) {
            const context = canvas.getContext('2d');
            const pixelBuffer = new Uint32Array(context.getImageData(0, 0, canvas.width, canvas.height).data.buffer);
            return !pixelBuffer.some(color => color !== 0);
        }

        // --- DATA ---
        function saveData() {
            const d = {
                store: document.getElementById('storeNumber').value,
                date: document.getElementById('workDate').value,
                lead: document.getElementById('leadName').value,
                inMgr: document.getElementById('checkInManager').value,
                outMgr: document.getElementById('checkOutManager').value,
                commodities: document.getElementById('commodities').value,
                issue: document.getElementById('issueDesc').value,
                temp: document.getElementById('tempSolution').value,
                notes: document.getElementById('notes').value,
                toggles: state.data,
                photos: state.photos,
                emailTo: document.getElementById('emailTo').value
            };
            localStorage.setItem('kompass_v34_data', JSON.stringify(d));
        }

        function loadSavedData() {
            const raw = localStorage.getItem('kompass_v34_data');
            if (!raw) return;
            const d = JSON.parse(raw);

            document.getElementById('storeNumber').value = d.store || '';
            document.getElementById('workDate').value = d.date || '';
            document.getElementById('leadName').value = d.lead || '';
            document.getElementById('checkInManager').value = d.inMgr || '';
            document.getElementById('checkOutManager').value = d.outMgr || '';
            document.getElementById('commodities').value = d.commodities || '';
            document.getElementById('issueDesc').value = d.issue || '';
            document.getElementById('tempSolution').value = d.temp || '';
            document.getElementById('notes').value = d.notes || '';
            document.getElementById('emailTo').value = d.emailTo || '';

            if(d.toggles) {
                setToggle('hotline', d.toggles.hotline);
                setToggle('prod', d.toggles.prod);
                setToggle('si', d.toggles.si);
                if(d.toggles.resolved) {
                    document.getElementById('issueResolved').value = d.toggles.resolved;
                    handleResolvedChange();
                }
                setToggle('beforeTaken', d.toggles.beforeTaken || false);
                setToggle('afterTaken', d.toggles.afterTaken || false);
                setToggle('signoffTaken', d.toggles.signoffTaken || false);
            }

            if(d.photos) {
                state.photos = d.photos;
                renderPhotos('before');
                renderPhotos('after');
                renderPhotos('signoff');
            }
        }

        function validateAndSubmit() {
            document.querySelectorAll('.field-group').forEach(el => el.classList.remove('error-state'));
            let firstError = null;
            const markError = (id) => {
                const el = document.getElementById(id);
                if (el) { el.classList.add('error-state'); if (!firstError) firstError = el; }
            };
            const req = (id, pid) => {
                const el = document.getElementById(id);
                if (!el.value.trim()) { markError(pid || `fg-${id}`); return false; }
                return true;
            };

            if (!document.getElementById('storeNumber').value) markError('fg-store');
            if (!document.getElementById('workDate').value) markError('fg-date');
            req('leadName', 'fg-lead');
            req('checkInManager', 'fg-inMgr');

            if (state.data.hotline) {
                req('commodities', 'fg-comm');
                req('issueDesc', 'fg-issue');
                if (document.getElementById('issueResolved').value === 'No') req('tempSolution', 'tempSolutionGroup');
            }
            req('checkOutManager', 'fg-outMgr');
            
            const canvas = document.getElementById('sigCanvas');
            if (isCanvasBlank(canvas)) markError('fg-sig');

            if (firstError) firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            else finishEOD();
        }

        async function finishEOD() {
            document.getElementById('loadingModal').style.display = 'flex';
            const getVal = (id) => document.getElementById(id).value;
            
            try {
                const pdfBytes = await generatePDF();
                const store = getVal('storeNumber').padStart(3,'0');
                const dateVal = getVal('workDate');
                const [dy, dm, dd] = dateVal.split('-');
                const dateStr = `${dm}_${dd}_${dy}`;
                const filename = `KOMPASS EOD Cover Sheet FM${store} ${dateStr}.pdf`;
                
                const file = new File([pdfBytes], filename, { type: 'application/pdf' });

                const emailTo = getVal('emailTo');
                const cc = "aiyana.natarisalazar@retailodyssey.com; tyson.gauthier@retailodyssey.com";
                const subject = `KOMPASS EOD FM${store} ${dm}/${dd}/${dy}`;
                const yn = (val) => val ? 'Yes' : 'No';
                const naIfFalse = (cond, val) => cond ? val : 'N/A';
                
                const body = `Lead Name: ${getVal('leadName')}
Date: ${getVal('workDate')}
Store Number: ${getVal('storeNumber')}

Before picture of KOMPASS cart taken: ${yn(state.data.beforeTaken)}
Manager checked in with: ${getVal('checkInManager')}

Called KOMPASS Hotline: ${yn(state.data.hotline)}
Commodities: ${naIfFalse(state.data.hotline, getVal('commodities'))}
Issue: ${naIfFalse(state.data.hotline, getVal('issueDesc'))}
Issue resolved: ${naIfFalse(state.data.hotline, state.data.resolved)}
Temporary solution: ${(state.data.hotline && state.data.resolved === 'No') ? getVal('tempSolution') : 'N/A'}

Manager checked out with: ${getVal('checkOutManager')}
Signed out in PROD: ${yn(state.data.prod)}
Signed out in SI: ${yn(state.data.si)}

After picture of KOMPASS cart taken: ${yn(state.data.afterTaken)}
Sign-off sheets photographed: ${yn(state.data.signoffTaken)}
Number of sign-off photos: ${state.photos.signoff.length}

Notes:
${getVal('notes')}`;

                // Populate Share Modal Data
                document.getElementById('modalTo').value = emailTo;
                document.getElementById('modalCC').value = cc;
                
                state.tempShareData = {
                    files: [file],
                    title: subject,
                    text: body
                };

                // If Share API not supported, just download and mailto immediately
                if (!navigator.canShare || !navigator.canShare({ files: [file] })) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(file);
                    link.download = filename;
                    link.click();
                    window.location.href = `mailto:${emailTo}?cc=${cc}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    document.getElementById('loadingModal').style.display = 'none';
                    return;
                }

                // Otherwise show custom modal
                document.getElementById('loadingModal').style.display = 'none';
                document.getElementById('shareModal').style.display = 'flex';

            } catch (e) {
                alert("Error: " + e.message);
                document.getElementById('loadingModal').style.display = 'none';
            }
        }

        function copyText(id) {
            const el = document.getElementById(id);
            el.select();
            el.setSelectionRange(0, 99999); // Mobile
            navigator.clipboard.writeText(el.value).then(() => {
                const btn = el.nextElementSibling;
                const orig = btn.textContent;
                btn.textContent = "‚úÖ";
                setTimeout(() => btn.textContent = orig, 1500);
            });
        }

        async function triggerNativeShare() {
            if (state.tempShareData) {
                try {
                    await navigator.share(state.tempShareData);
                } catch (err) {
                    if (err.name !== 'AbortError') alert("Share failed: " + err.message);
                }
            }
        }

        function closeShareModal() {
            document.getElementById('shareModal').style.display = 'none';
        }

        function resetForm() {
            if(confirm("Clear all data and photos?")) {
                localStorage.removeItem('kompass_v34_data');
                location.reload();
            }
        }

        // --- PDF GEN ---
        async function generatePDF() {
            const url = 'End Of Day Cover Sheet Form Editable Template.pdf';
            const existingPdfBytes = await fetch(url).then(res => res.arrayBuffer());
            const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
            const form = pdfDoc.getForm();
            const getVal = (id) => document.getElementById(id).value;

            const store = getVal('storeNumber').padStart(3,'0');
            const dateVal = getVal('workDate');
            const [dy, dm, dd] = dateVal.split('-');
            const headerText = `KOMPASS EOD Cover Sheet FM${store} ${dm}_${dd}_${dy}`;

            try {
                form.getTextField('LeadName').setText(getVal('leadName'));
                form.getTextField('DateISO').setText(getVal('workDate'));
                form.getTextField('StoreNumber').setText(getVal('storeNumber'));
                form.getTextField('CheckInManager').setText(getVal('checkInManager'));
                form.getTextField('CheckOutManager').setText(getVal('checkOutManager'));
                
                if (state.data.hotline) {
                    form.getRadioGroup('CalledHotline').select('Yes');
                    form.getTextField('IssueCommodities').setText(getVal('commodities'));
                    form.getTextField('WhatIsIssue').setText(getVal('issueDesc'));
                    const resolved = document.getElementById('issueResolved').value;
                    if (resolved !== 'NA') form.getRadioGroup('IssueResolved').select(resolved === 'Yes' ? 'Yes' : 'No');
                    if (resolved === 'No') form.getTextField('TempSolution').setText(getVal('tempSolution'));
                } else {
                    form.getRadioGroup('CalledHotline').select('No');
                    form.getTextField('IssueCommodities').setText('N/A');
                    form.getTextField('WhatIsIssue').setText('N/A');
                    try { form.getRadioGroup('IssueResolved').select('NA'); } catch(e) {}
                }

                form.getRadioGroup('SignedOutPROD').select(state.data.prod ? 'Yes' : 'No');
                form.getRadioGroup('SignedOutSI').select(state.data.si ? 'Yes' : 'No');
                form.getRadioGroup('BeforePicPosted').select(state.data.beforeTaken ? 'Yes' : 'No');
                form.getRadioGroup('AfterPicPosted').select(state.data.afterTaken ? 'Yes' : 'No');
                const so = state.data.signoffTaken;
                form.getRadioGroup('SignoutSheetAttachedEmail').select(so ? 'Yes' : 'No');
                form.getRadioGroup('SignoutSheetAttachedPROD').select(so ? 'Yes' : 'No');

                const canvas = document.getElementById('sigCanvas');
                if (!isCanvasBlank(canvas)) {
                    const sigImg = await pdfDoc.embedPng(canvas.toDataURL());
                    try { form.getButton('LeadSignatureImage').setImage(sigImg); } catch(e) {
                        pdfDoc.getPages()[0].drawImage(sigImg, { x: 400, y: 80, width: 150, height: 50 });
                    }
                }
            } catch (e) { console.warn(e); }

            form.flatten();

            const hasBefore = state.photos.before.length > 0;
            const hasAfter = state.photos.after.length > 0;
            if (hasBefore || hasAfter) {
                const page = pdfDoc.addPage();
                const { width, height } = page.getSize();
                if (hasBefore) {
                    const img = await pdfDoc.embedJpg(state.photos.before[0]);
                    page.drawText('Kompass Cart - Before', { x: 50, y: 750, size: 18 });
                    const dims = img.scaleToFit(512, 320);
                    page.drawImage(img, { x: (width - dims.width) / 2, y: 730 - dims.height, width: dims.width, height: dims.height });
                }
                if (hasAfter) {
                    const img = await pdfDoc.embedJpg(state.photos.after[0]);
                    page.drawText('Kompass Cart - After', { x: 50, y: 380, size: 18 });
                    const dims = img.scaleToFit(512, 320);
                    page.drawImage(img, { x: (width - dims.width) / 2, y: 360 - dims.height, width: dims.width, height: dims.height });
                }
            }

            for (let i = 0; i < state.photos.signoff.length; i++) {
                const page = pdfDoc.addPage();
                const { width, height } = page.getSize();
                const img = await pdfDoc.embedJpg(state.photos.signoff[i]);
                page.drawText(`Sign-Off Sheet ${i + 1}`, { x: 50, y: 750, size: 18 });
                const dims = img.scaleToFit(512, 680);
                page.drawImage(img, { x: (width - dims.width) / 2, y: 730 - dims.height, width: dims.width, height: dims.height });
            }

            const allPages = pdfDoc.getPages();
            const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
            allPages.forEach(page => {
                const { width, height } = page.getSize();
                const textWidth = font.widthOfTextAtSize(headerText, 10);
                page.drawText(headerText, {
                    x: width - textWidth - 20,
                    y: height - 15,
                    size: 10,
                    font: font,
                    color: PDFLib.rgb(0.4, 0.4, 0.4)
                });
            });

            return await pdfDoc.save();
        }
    </script>
</body>
</html>
