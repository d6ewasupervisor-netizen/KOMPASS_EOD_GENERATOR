<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KOMPASS EOD System v2.2</title>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <style>
        :root {
            --primary: #0d4f8b;
            --primary-hover: #1e66ab;
            --secondary: #4b5563;
            --success: #56ab2f;
            --danger: #dc2626;
            --background: #374151;
            --surface: #111827;
            --surface-alt: #020617;
            --text-main: #f9fafb;
            --text-muted: #d1d5db;
            --accent: #88c4ed;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--background);
            color: var(--text-main);
            height: 100vh;
            height: 100dvh; /* Mobile viewport fix */
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* --- Header --- */
        .app-header {
            background: var(--surface);
            padding: 12px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 10;
            flex-shrink: 0;
        }
        .header-logo { max-height: 35px; margin-bottom: 5px; }
        .app-title { color: var(--accent); font-size: 1.1rem; font-weight: 700; margin: 0; }

        /* --- Main Content Area --- */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 100px; /* Space for footer */
            scroll-behavior: smooth;
        }

        .section-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .section-title {
            color: var(--accent);
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--secondary);
        }

        /* --- Forms --- */
        .field-group { margin-bottom: 20px; scroll-margin-top: 80px; }
        label { display: block; margin-bottom: 8px; color: var(--text-muted); font-size: 0.9rem; font-weight: 600; }
        
        input[type="text"], input[type="date"], input[type="email"], textarea, select {
            width: 100%;
            padding: 12px;
            background: var(--surface-alt);
            border: 1px solid var(--secondary);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent); }
        
        /* Error States */
        .field-group.error-state input, 
        .field-group.error-state textarea,
        .field-group.error-state select,
        .field-group.error-state canvas { 
            border-color: var(--danger); 
            box-shadow: 0 0 0 1px var(--danger);
        }
        
        .error-msg { 
            color: var(--danger); 
            font-size: 0.85rem; 
            margin-top: 5px; 
            display: none; 
            font-weight: bold;
        }
        .field-group.error-state .error-msg { display: block; }

        /* --- Toggle Buttons (Radios) --- */
        .toggle-group { display: flex; gap: 10px; background: var(--surface-alt); padding: 4px; border-radius: 8px; margin-bottom: 10px; }
        .toggle-option { flex: 1; text-align: center; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; color: var(--text-muted); transition: all 0.2s; }
        .toggle-option.selected { background: var(--primary); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        /* --- Photos --- */
        .photo-section {
            background: rgba(255,255,255,0.03);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .photo-slot {
            aspect-ratio: 1;
            background: var(--surface-alt);
            border: 1px dashed var(--secondary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .photo-slot img { width: 100%; height: 100%; object-fit: cover; }
        
        .photo-actions {
            position: absolute; inset: 0; background: rgba(0,0,0,0.7);
            display: none; flex-direction: column; align-items: center; justify-content: center; gap: 8px;
        }
        .photo-slot:hover .photo-actions { display: flex; }
        
        .mini-btn { padding: 4px 8px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.75rem; color: white; }
        .btn-delete { background: var(--danger); }

        .add-photo-btn { flex-direction: column; gap: 2px; color: var(--accent); text-align: center; }
        .add-photo-btn span { font-size: 1.5rem; }

        /* --- Signature --- */
        .sig-pad-container { background: white; border-radius: 8px; height: 150px; position: relative; touch-action: none; border: 1px solid var(--secondary); }
        canvas#sigCanvas { width: 100%; height: 100%; display: block; }
        .sig-overlay-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #999; pointer-events: none; font-style: italic; }

        /* --- Navigation Footer --- */
        .nav-footer {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--surface);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            gap: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
            z-index: 100;
        }

        .btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.95rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-reset { background: var(--secondary); color: white; width: 30%; }
        .btn-submit { background: var(--success); color: white; width: 70%; }
        .btn:active { transform: translateY(2px); }

        /* --- Camera Overlay (Improved) --- */
        .overlay {
            position: fixed; inset: 0; z-index: 2000;
            background: #000; display: none; flex-direction: column;
            height: 100%; width: 100%;
        }
        .overlay.active { display: flex; }

        /* Top Bar */
        .cam-tools {
            flex-shrink: 0; z-index: 2010;
            padding: 15px; background: rgba(0,0,0,0.5);
            display: flex; justify-content: space-between; align-items: center;
        }
        
        /* Video Area */
        .cam-view {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }
        video#cameraFeed {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Fill screen */
        }

        /* Bottom Bar */
        .cam-controls {
            flex-shrink: 0; z-index: 2010;
            height: 100px;
            background: rgba(0,0,0,0.8);
            display: flex; align-items: center; justify-content: center;
        }

        .shutter-btn {
            width: 70px; height: 70px; border-radius: 50%;
            background: white; border: 4px solid var(--secondary);
            cursor: pointer; box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        .shutter-btn:active { transform: scale(0.9); background: #ccc; }

        .tool-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 15px; border-radius: 20px; backdrop-filter: blur(4px); font-weight: bold; }

        /* Zoom Control in Header */
        #zoomControls { display: flex; align-items: center; gap: 10px; flex: 1; justify-content: center; margin: 0 15px; }
        input[type=range] { flex: 1; max-width: 150px; height: 4px; }

        /* Editor */
        .editor-stage { flex: 1; background: #111; position: relative; display: flex; align-items: center; justify-content: center; }
        .editor-toolbar {
            flex-shrink: 0; padding: 15px; background: var(--surface);
            display: flex; gap: 10px; justify-content: space-around;
        }

        /* Loading Modal */
        .modal-backdrop {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000;
            display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: var(--surface); padding: 25px; border-radius: 12px;
            width: 90%; max-width: 350px; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid var(--secondary);
            border-top: 4px solid var(--accent); border-radius: 50%;
            margin: 0 auto 15px auto; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- Header -->
    <header class="app-header">
        <img src="rologo.png" alt="Logo" class="header-logo" onerror="this.style.display='none'">
        <h1 class="app-title">KOMPASS EOD System</h1>
    </header>
    
    <!-- Main Scrolling Content -->
    <main class="main-content" id="mainContainer">
        
        <!-- SECTION: IDENTIFICATION -->
        <div class="section-card">
            <div class="section-title">Identification</div>
            
            <div class="field-group" id="fg-store">
                <label>Store Number *</label>
                <input type="text" id="storeNumber" placeholder="###" inputmode="numeric" maxlength="3" onchange="saveData()">
                <div class="error-msg">Enter 3-digit store number</div>
            </div>

            <div class="field-group" id="fg-date">
                <label>Date *</label>
                <input type="date" id="workDate" onchange="saveData()">
                <div class="error-msg">Date cannot be in the future</div>
            </div>

            <div class="field-group" id="fg-lead">
                <label>Lead Name *</label>
                <input type="text" id="leadName" placeholder="First Last" onchange="saveData()">
                <div class="error-msg">Lead name required</div>
            </div>

            <div class="field-group" id="fg-inMgr">
                <label>Manager Checked In With *</label>
                <input type="text" id="checkInManager" onchange="saveData()">
                <div class="error-msg">Manager name required</div>
            </div>
        </div>

        <!-- SECTION: PHOTOS -->
        <div class="section-card">
            <div class="section-title">Photos</div>
            
            <!-- Before -->
            <div class="photo-section">
                <label>Before picture of KOMPASS cart taken? *</label>
                <div class="toggle-group" id="tg-beforeTaken">
                    <div class="toggle-option" onclick="setToggle('beforeTaken', true)">Yes</div>
                    <div class="toggle-option selected" onclick="setToggle('beforeTaken', false)">No</div>
                </div>

                <label style="font-size: 0.85rem; margin-top: 10px;">Add Evidence Photos (Optional):</label>
                <div class="photo-grid" id="grid-before">
                    <div class="photo-slot add-photo-btn" onclick="launchCamera('before')">
                        <span>üì∑</span><div>Cam</div>
                    </div>
                    <div class="photo-slot add-photo-btn" onclick="document.getElementById('file-before').click()">
                        <span>üìÅ</span><div>File</div>
                    </div>
                </div>
                <input type="file" id="file-before" hidden accept="image/*" onchange="handleFileUpload(this, 'before')">
            </div>

            <!-- After -->
            <div class="photo-section">
                <label>After picture of KOMPASS cart taken? *</label>
                <div class="toggle-group" id="tg-afterTaken">
                    <div class="toggle-option" onclick="setToggle('afterTaken', true)">Yes</div>
                    <div class="toggle-option selected" onclick="setToggle('afterTaken', false)">No</div>
                </div>

                <label style="font-size: 0.85rem; margin-top: 10px;">Add Evidence Photos (Optional):</label>
                <div class="photo-grid" id="grid-after">
                    <div class="photo-slot add-photo-btn" onclick="launchCamera('after')">
                        <span>üì∑</span><div>Cam</div>
                    </div>
                    <div class="photo-slot add-photo-btn" onclick="document.getElementById('file-after').click()">
                        <span>üìÅ</span><div>File</div>
                    </div>
                </div>
                <input type="file" id="file-after" hidden accept="image/*" onchange="handleFileUpload(this, 'after')">
            </div>

            <!-- Signoff -->
            <div class="photo-section">
                <label>Sign-Off Sheets taken? *</label>
                <div class="toggle-group" id="tg-signoffTaken">
                    <div class="toggle-option" onclick="setToggle('signoffTaken', true)">Yes</div>
                    <div class="toggle-option selected" onclick="setToggle('signoffTaken', false)">No</div>
                </div>

                <label style="font-size: 0.85rem; margin-top: 10px;">Add Evidence Photos (Optional):</label>
                <div class="photo-grid" id="grid-signoff">
                    <div class="photo-slot add-photo-btn" onclick="launchCamera('signoff')">
                        <span>üì∑</span><div>Cam</div>
                    </div>
                    <div class="photo-slot add-photo-btn" onclick="document.getElementById('file-signoff').click()">
                        <span>üìÅ</span><div>File</div>
                    </div>
                </div>
                <input type="file" id="file-signoff" hidden accept="image/*" multiple onchange="handleFileUpload(this, 'signoff')">
            </div>
        </div>

        <!-- SECTION: ISSUES -->
        <div class="section-card">
            <div class="section-title">Issues & Check Out</div>

            <!-- Hotline Logic -->
            <div class="field-group">
                <label>Did you call KOMPASS Hotline? *</label>
                <div class="toggle-group" id="tg-hotline">
                    <div class="toggle-option" onclick="setToggle('hotline', true)">Yes</div>
                    <div class="toggle-option selected" onclick="setToggle('hotline', false)">No</div>
                </div>
            </div>

            <div id="hotline-fields" style="display:none; border-left: 2px solid var(--accent); padding-left: 15px; margin-bottom: 20px;">
                <div class="field-group" id="fg-comm">
                    <label>Commodities *</label>
                    <input type="text" id="commodities" onchange="saveData()">
                    <div class="error-msg">Required</div>
                </div>
                <div class="field-group" id="fg-issue">
                    <label>Issue Description *</label>
                    <textarea id="issueDesc" rows="2" onchange="saveData()"></textarea>
                    <div class="error-msg">Required</div>
                </div>
                <div class="field-group">
                    <label>Resolved? *</label>
                    <select id="issueResolved" onchange="handleResolvedChange()">
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                        <option value="NA">N/A</option>
                    </select>
                </div>
                <div class="field-group" id="tempSolutionGroup" style="display:none;">
                    <label>Temporary Solution *</label>
                    <textarea id="tempSolution" rows="2" onchange="saveData()"></textarea>
                    <div class="error-msg">Required if not resolved</div>
                </div>
            </div>

            <div class="field-group" id="fg-outMgr">
                <label>Manager Checked Out With *</label>
                <input type="text" id="checkOutManager" onchange="saveData()">
                <div class="error-msg">Manager name required</div>
            </div>

            <div class="field-group">
                <label>Signed out in PROD? *</label>
                <div class="toggle-group" id="tg-prod">
                    <div class="toggle-option" onclick="setToggle('prod', true)">Yes</div>
                    <div class="toggle-option selected" onclick="setToggle('prod', false)">No</div>
                </div>
            </div>

            <div class="field-group">
                <label>Signed out in SI? *</label>
                <div class="toggle-group" id="tg-si">
                    <div class="toggle-option" onclick="setToggle('si', true)">Yes</div>
                    <div class="toggle-option selected" onclick="setToggle('si', false)">No</div>
                </div>
            </div>

            <div class="field-group">
                <label>General Notes</label>
                <textarea id="notes" rows="3" placeholder="Optional notes..." onchange="saveData()"></textarea>
            </div>
        </div>

        <!-- SECTION: SIGNATURE -->
        <div class="section-card">
            <div class="section-title">Review & Sign</div>
            
            <div class="field-group">
                <label>Email To (Optional)</label>
                <input type="email" id="emailTo" placeholder="manager@example.com" onchange="saveData()">
            </div>

            <div class="field-group" id="fg-sig">
                <label>Signature *</label>
                <div class="sig-pad-container">
                    <canvas id="sigCanvas"></canvas>
                    <div class="sig-overlay-text" id="sigPlaceholder">Sign Here</div>
                </div>
                <button class="mini-btn btn-reset" onclick="clearSignature()" style="margin-top: 8px; width: 100%;">Clear / Retry</button>
                <div class="error-msg">Signature required</div>
            </div>
        </div>

    </main>

    <!-- Footer Actions -->
    <footer class="nav-footer">
        <button class="btn btn-reset" onclick="resetForm()">Reset</button>
        <button class="btn btn-submit" onclick="validateAndSubmit()">Generate PDF & Email</button>
    </footer>

    <!-- OVERLAY: CAMERA (Improved Layout) -->
    <div id="cameraOverlay" class="overlay">
        <div class="cam-tools">
            <button class="tool-btn" onclick="closeCamera()">Cancel</button>
            
            <!-- Zoom Controls moved to top -->
            <div id="zoomControls" style="display:none;">
                <span>-</span>
                <input type="range" id="zoomSlider" min="1" max="5" step="0.1" value="1">
                <span>+</span>
            </div>

            <button class="tool-btn" id="btnFlash" onclick="toggleFlash()">‚ö° Off</button>
        </div>
        
        <div class="cam-view">
            <video id="cameraFeed" autoplay playsinline></video>
        </div>
        
        <div class="cam-controls">
            <button class="shutter-btn" onclick="takePhoto()"></button>
        </div>
    </div>

    <!-- OVERLAY: EDITOR -->
    <div id="editorOverlay" class="overlay">
        <div class="cam-tools" style="background: var(--surface);">
            <button class="tool-btn" onclick="closeEditor(false)">Discard</button>
            <span style="margin: auto; font-weight: bold; color:white;">Edit Photo</span>
            <button class="tool-btn" style="background: var(--primary);" onclick="saveEditor()">Save</button>
        </div>
        <div class="editor-stage">
            <img id="editorImage" style="max-width: 100%; display: none;">
        </div>
        <div class="editor-toolbar">
            <button class="btn btn-reset" style="width:auto" onclick="editorRotate(-90)">‚Ü∫</button>
            <button class="btn btn-reset" style="width:auto" onclick="editorRotate(90)">‚Üª</button>
            <button class="btn btn-reset" style="width:auto" onclick="editorZoom(0.1)">üîç+</button>
        </div>
    </div>

    <!-- MODAL: LOADING -->
    <div id="loadingModal" class="modal-backdrop">
        <div class="modal-box">
            <div class="spinner"></div>
            <h3 style="color: var(--accent);">Processing</h3>
            <p>Generating PDF and preparing email...</p>
        </div>
    </div>

    <script>
        // --- STATE ---
        const state = {
            data: {
                hotline: false,
                prod: false,
                si: false,
                resolved: 'NA',
                // New Photo Toggles (Default to false)
                beforeTaken: false,
                afterTaken: false,
                signoffTaken: false
            },
            photos: { before: [], after: [], signoff: [] },
            currentPhotoCategory: null,
            cameraStream: null,
            cropper: null
        };

        // --- INIT ---
        window.addEventListener('load', () => {
            document.getElementById('workDate').valueAsDate = new Date();
            setupSignature();
            loadSavedData();
        });

        // --- FORM LOGIC ---
        function setToggle(key, value) {
            state.data[key] = value;
            const container = document.getElementById(`tg-${key}`);
            const options = container.querySelectorAll('.toggle-option');
            options[0].classList.toggle('selected', value);
            options[1].classList.toggle('selected', !value);

            if (key === 'hotline') {
                document.getElementById('hotline-fields').style.display = value ? 'block' : 'none';
            }
            saveData();
        }

        function handleResolvedChange() {
            const val = document.getElementById('issueResolved').value;
            state.data.resolved = val;
            document.getElementById('tempSolutionGroup').style.display = (val === 'No') ? 'block' : 'none';
            saveData();
        }

        // --- VALIDATION & SUBMIT ---
        function validateAndSubmit() {
            // Clear previous errors
            document.querySelectorAll('.field-group').forEach(el => el.classList.remove('error-state'));
            let firstError = null;

            const req = (id, parentId) => {
                const el = document.getElementById(id);
                if (!el.value.trim()) {
                    markError(parentId || `fg-${id}`);
                    return false;
                }
                return true;
            };

            const markError = (id) => {
                const el = document.getElementById(id);
                if (el) {
                    el.classList.add('error-state');
                    if (!firstError) firstError = el;
                }
            };

            // 1. Identification
            if (!/^\d{3}$/.test(document.getElementById('storeNumber').value)) markError('fg-store');
            
            const dVal = document.getElementById('workDate').value;
            if (!dVal) markError('fg-date');
            else {
                const inputDate = new Date(dVal);
                const today = new Date();
                today.setHours(23,59,59,999);
                if(inputDate > today) markError('fg-date');
            }

            req('leadName', 'fg-lead');
            req('checkInManager', 'fg-inMgr');

            // 2. Photos (Removed strict array length check, using toggles now)
            // No validation needed here as "No" is a valid option per prompt
            // But we could force them to select Yes/No if we wanted. Currently defaulting to No is safe.

            // 3. Issues
            if (state.data.hotline) {
                req('commodities', 'fg-comm');
                req('issueDesc', 'fg-issue');
                if (document.getElementById('issueResolved').value === 'No') {
                    req('tempSolution', 'tempSolutionGroup');
                }
            }
            req('checkOutManager', 'fg-outMgr');

            // 4. Signature
            const canvas = document.getElementById('sigCanvas');
            if (isCanvasBlank(canvas)) markError('fg-sig');

            // Result
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                finishEOD();
            }
        }

        async function finishEOD() {
            document.getElementById('loadingModal').style.display = 'flex';
            
            try {
                const pdfBytes = await generatePDF();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                
                const store = document.getElementById('storeNumber').value.padStart(3,'0');
                const dateObj = new Date(document.getElementById('workDate').value);
                const dateStr = `${String(dateObj.getMonth()+1).padStart(2,'0')}_${String(dateObj.getDate()).padStart(2,'0')}_${dateObj.getFullYear()}`;
                const filename = `KOMPASS EOD Cover Sheet FM${store} ${dateStr}.pdf`;

                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();

                const emailTo = document.getElementById('emailTo').value;
                const cc = "aiyana.natarisalazar@retailodyssey.com; tyson.gauthier@retailodyssey.com";
                const subject = `KOMPASS EOD FM${store} ${dateObj.toLocaleDateString()}`;
                const body = `Attached: EOD Report for Store ${store}.\n\nLead: ${document.getElementById('leadName').value}\nNotes: ${document.getElementById('notes').value}`;
                
                window.location.href = `mailto:${emailTo}?cc=${cc}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

            } catch (e) {
                alert("Error: " + e.message);
                console.error(e);
            } finally {
                document.getElementById('loadingModal').style.display = 'none';
            }
        }

        // --- PHOTOS, CAMERA, EDITOR ---
        async function launchCamera(category) {
            state.currentPhotoCategory = category;
            const overlay = document.getElementById('cameraOverlay');
            const video = document.getElementById('cameraFeed');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: { ideal: 1920 } } 
                });
                state.cameraStream = stream;
                video.srcObject = stream;
                overlay.classList.add('active');

                const track = stream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();
                const zoomCtrl = document.getElementById('zoomControls');
                
                if (capabilities.zoom) {
                    const slider = document.getElementById('zoomSlider');
                    zoomCtrl.style.display = 'flex';
                    slider.min = capabilities.zoom.min;
                    slider.max = capabilities.zoom.max;
                    slider.step = capabilities.zoom.step || 0.1;
                    slider.oninput = () => track.applyConstraints({ advanced: [{ zoom: slider.value }] });
                } else {
                    zoomCtrl.style.display = 'none';
                }

                document.getElementById('btnFlash').style.display = capabilities.torch ? 'block' : 'none';

            } catch (err) {
                alert("Camera unavailable. Please check permissions.");
            }
        }

        function takePhoto() {
            const video = document.getElementById('cameraFeed');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
            closeCamera();
            openEditor(dataUrl);
        }

        function closeCamera() {
            if (state.cameraStream) {
                state.cameraStream.getTracks().forEach(t => t.stop());
                state.cameraStream = null;
            }
            document.getElementById('cameraOverlay').classList.remove('active');
        }

        function toggleFlash() {
            if (!state.cameraStream) return;
            const track = state.cameraStream.getVideoTracks()[0];
            const current = track.getSettings().torch || false;
            track.applyConstraints({ advanced: [{ torch: !current }] });
            document.getElementById('btnFlash').innerText = !current ? '‚ö° On' : '‚ö° Off';
        }

        function handleFileUpload(input, category) {
            state.currentPhotoCategory = category;
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => openEditor(e.target.result);
                reader.readAsDataURL(input.files[0]);
            }
            input.value = '';
        }

        function openEditor(imageUrl) {
            const overlay = document.getElementById('editorOverlay');
            const img = document.getElementById('editorImage');
            img.src = imageUrl;
            overlay.classList.add('active');
            if (state.cropper) state.cropper.destroy();
            img.style.display = 'block';
            state.cropper = new Cropper(img, { viewMode: 1, dragMode: 'move', autoCropArea: 0.9, background: false });
        }

        function editorRotate(deg) { if (state.cropper) state.cropper.rotate(deg); }
        function editorZoom(ratio) { if (state.cropper) state.cropper.zoom(ratio); }
        
        function saveEditor() {
            if (!state.cropper) return;
            const category = state.currentPhotoCategory;
            const canvas = state.cropper.getCroppedCanvas({ maxWidth: 1200, maxHeight: 1200 });
            
            // Save Photo
            state.photos[category].push(canvas.toDataURL('image/jpeg', 0.8));
            
            // Auto-Set Toggle to YES
            setToggle(category + 'Taken', true);
            
            closeEditor(true);
            renderPhotos(category);
            saveData();
        }
        
        function closeEditor() {
            document.getElementById('editorOverlay').classList.remove('active');
            if (state.cropper) state.cropper.destroy();
            state.cropper = null;
        }

        function renderPhotos(category) {
            const container = document.getElementById(`grid-${category}`);
            const existing = container.querySelectorAll('.photo-item-wrapper');
            existing.forEach(e => e.remove());

            state.photos[category].forEach((src, idx) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'photo-slot photo-item-wrapper';
                wrapper.innerHTML = `
                    <img src="${src}">
                    <div class="photo-actions">
                        <button class="mini-btn btn-delete" onclick="deletePhoto('${category}', ${idx})">Delete</button>
                    </div>
                `;
                container.insertBefore(wrapper, container.children[container.children.length - 2]);
            });
        }

        function deletePhoto(cat, idx) {
            state.photos[cat].splice(idx, 1);
            // If no photos left, maybe toggle back to No? 
            // The request didn't specify, but usually safer to leave as Yes if they manually set it, 
            // or flip to No if they remove all evidence. I'll flip to No if empty.
            if(state.photos[cat].length === 0) {
                setToggle(cat + 'Taken', false);
            }
            renderPhotos(cat);
            saveData();
        }

        // --- SIGNATURE ---
        function setupSignature() {
            const canvas = document.getElementById('sigCanvas');
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            const ctx = canvas.getContext('2d');
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            
            let drawing = false;
            const start = (e) => {
                drawing = true;
                document.getElementById('sigPlaceholder').style.display = 'none';
                document.getElementById('fg-sig').classList.remove('error-state');
                ctx.beginPath();
                const {x, y} = getPos(e);
                ctx.moveTo(x, y);
            };
            const move = (e) => {
                if (!drawing) return;
                e.preventDefault();
                const {x, y} = getPos(e);
                ctx.lineTo(x, y);
                ctx.stroke();
            };
            const end = () => drawing = false;
            const getPos = (e) => {
                const r = canvas.getBoundingClientRect();
                const cx = e.touches ? e.touches[0].clientX : e.clientX;
                const cy = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: cx - r.left, y: cy - r.top };
            };

            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', move);
            canvas.addEventListener('mouseup', end);
            canvas.addEventListener('touchstart', start);
            canvas.addEventListener('touchmove', move);
            canvas.addEventListener('touchend', end);
        }

        function clearSignature() {
            const canvas = document.getElementById('sigCanvas');
            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('sigPlaceholder').style.display = 'block';
        }
        
        function isCanvasBlank(canvas) {
            const context = canvas.getContext('2d');
            const pixelBuffer = new Uint32Array(context.getImageData(0, 0, canvas.width, canvas.height).data.buffer);
            return !pixelBuffer.some(color => color !== 0);
        }

        // --- DATA & RESET ---
        function saveData() {
            const d = {
                store: document.getElementById('storeNumber').value,
                date: document.getElementById('workDate').value,
                lead: document.getElementById('leadName').value,
                inMgr: document.getElementById('checkInManager').value,
                outMgr: document.getElementById('checkOutManager').value,
                commodities: document.getElementById('commodities').value,
                issue: document.getElementById('issueDesc').value,
                temp: document.getElementById('tempSolution').value,
                notes: document.getElementById('notes').value,
                toggles: state.data,
                photos: state.photos,
                emailTo: document.getElementById('emailTo').value
            };
            localStorage.setItem('kompass_v22_data', JSON.stringify(d));
        }

        function loadSavedData() {
            const raw = localStorage.getItem('kompass_v22_data');
            if (!raw) return;
            const d = JSON.parse(raw);

            document.getElementById('storeNumber').value = d.store || '';
            document.getElementById('workDate').value = d.date || '';
            document.getElementById('leadName').value = d.lead || '';
            document.getElementById('checkInManager').value = d.inMgr || '';
            document.getElementById('checkOutManager').value = d.outMgr || '';
            document.getElementById('commodities').value = d.commodities || '';
            document.getElementById('issueDesc').value = d.issue || '';
            document.getElementById('tempSolution').value = d.temp || '';
            document.getElementById('notes').value = d.notes || '';
            document.getElementById('emailTo').value = d.emailTo || '';

            if(d.toggles) {
                setToggle('hotline', d.toggles.hotline);
                setToggle('prod', d.toggles.prod);
                setToggle('si', d.toggles.si);
                if(d.toggles.resolved) {
                    document.getElementById('issueResolved').value = d.toggles.resolved;
                    handleResolvedChange();
                }
                // Load new toggles
                setToggle('beforeTaken', d.toggles.beforeTaken || false);
                setToggle('afterTaken', d.toggles.afterTaken || false);
                setToggle('signoffTaken', d.toggles.signoffTaken || false);
            }

            if(d.photos) {
                state.photos = d.photos;
                renderPhotos('before');
                renderPhotos('after');
                renderPhotos('signoff');
            }
        }

        function resetForm() {
            if(confirm("Clear all data and photos?")) {
                localStorage.removeItem('kompass_v22_data');
                location.reload();
            }
        }

        // --- PDF GENERATION ---
        async function generatePDF() {
            const url = 'End Of Day Cover Sheet Form Editable Template.pdf';
            const existingPdfBytes = await fetch(url).then(res => res.arrayBuffer());
            const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
            const form = pdfDoc.getForm();

            const getVal = (id) => document.getElementById(id).value;
            
            try {
                form.getTextField('LeadName').setText(getVal('leadName'));
                form.getTextField('DateISO').setText(getVal('workDate'));
                form.getTextField('StoreNumber').setText(getVal('storeNumber'));
                form.getTextField('CheckInManager').setText(getVal('checkInManager'));
                form.getTextField('CheckOutManager').setText(getVal('checkOutManager'));
                
                if (state.data.hotline) {
                    form.getRadioGroup('CalledHotline').select('Yes');
                    form.getTextField('IssueCommodities').setText(getVal('commodities'));
                    form.getTextField('WhatIsIssue').setText(getVal('issueDesc'));
                    const resolved = document.getElementById('issueResolved').value;
                    if (resolved !== 'NA') form.getRadioGroup('IssueResolved').select(resolved === 'Yes' ? 'Yes' : 'No');
                    if (resolved === 'No') form.getTextField('TempSolution').setText(getVal('tempSolution'));
                } else {
                    form.getRadioGroup('CalledHotline').select('No');
                }

                form.getRadioGroup('SignedOutPROD').select(state.data.prod ? 'Yes' : 'No');
                form.getRadioGroup('SignedOutSI').select(state.data.si ? 'Yes' : 'No');
                
                // Use the new explicit toggles for PDF checkboxes
                form.getRadioGroup('BeforePicPosted').select(state.data.beforeTaken ? 'Yes' : 'No');
                form.getRadioGroup('AfterPicPosted').select(state.data.afterTaken ? 'Yes' : 'No');
                
                const so = state.data.signoffTaken;
                form.getRadioGroup('SignoutSheetAttachedEmail').select(so ? 'Yes' : 'No');
                form.getRadioGroup('SignoutSheetAttachedPROD').select(so ? 'Yes' : 'No');

                const canvas = document.getElementById('sigCanvas');
                if (!isCanvasBlank(canvas)) {
                    const sigImg = await pdfDoc.embedPng(canvas.toDataURL());
                    try { form.getButton('LeadSignatureImage').setImage(sigImg); } catch(e) {
                        pdfDoc.getPages()[0].drawImage(sigImg, { x: 400, y: 80, width: 150, height: 50 });
                    }
                }

            } catch (e) { console.warn("Mapping error", e); }

            form.flatten();

            // Photo Pages
            const allPhotos = [
                ...state.photos.before.map(p => ({t: 'Before', d: p})),
                ...state.photos.after.map(p => ({t: 'After', d: p})),
                ...state.photos.signoff.map(p => ({t: 'Sign-Off', d: p}))
            ];

            if (allPhotos.length > 0) {
                const page = pdfDoc.addPage();
                let y = page.getHeight() - 50;
                
                for (const p of allPhotos) {
                    if (y < 300) { y = page.getHeight() - 50; pdfDoc.addPage(); }
                    page.drawText(p.t, { x: 50, y, size: 18 });
                    y -= 20;
                    const img = await pdfDoc.embedJpg(p.d);
                    const dims = img.scaleToFit(400, 300);
                    page.drawImage(img, { x: 50, y: y - dims.height, width: dims.width, height: dims.height });
                    y -= (dims.height + 30);
                }
            }

            return await pdfDoc.save();
        }
    </script>
</body>
</html>
